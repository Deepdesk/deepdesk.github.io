<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deepdesk plugin integration approaches</title>
    <link href="./styles.css" rel="stylesheet">
</head>
<body>
    <h1>Deepdesk plugin integration approaches</h1>

    <h2>Introduction</h2>

    <p>
        The Deepdesk plugin empowers agents with AI by giving real-time suggestions above the agent's input field during a conversation.
    </p>

    <p>
        In order to function properly the plugin needs the following information:
    </p>

    <ol>
        <li>Reference to the input field</li>
        <li>Conversation ID (a.k.a. Case ID)</li>
        <li>Notification when the typed message is sent</li>
    </ol>

    <p>
        Although all information can be derived from the <code>DOM</code>, <code>Events</code>, <code>window</code> or <code>location</code>,
        without a proper "contract" this strategy is vulnerable to changes.
    </p>

    <p>
        Below we describe several approaches to make to plugin integration more solid.
    </p>

    <h2>Reference to input element and a conversation ID</h2>

    <p>
        In order to provide the plugin with a reference to the input element and a conversation ID we suggest providing the following data attribute on the agents input element containing the conversation ID:
    </p>

    <pre>data-autocomplete-conversation-id="XXXXXXXX"</pre>

    <p>
        The plugin can detect when an element with the data attribute is added to the page and attach itself to it and provide suggestings in the context of the provided conversation ID.
    </p>

    <p>
        Detecting an inserted input element (textarea/contenteditable div) is trivial for the plugin using the strategy <a href="https://davidwalsh.name/detect-node-insertion">described here</a>.
        You can also inspect the source code of this page.
    </p>

    <h3>Proof of concept</h3>

    <table>
        <tbody>
            <tr>
                <td width="50%" valign="top">
                    <h4>Agent chat</h4>
                    <button id="button2">Load conversation</button>
                    <br />
                    <div id="chat2"></div>
                </td>
                <td width="50%" valign="top">
                    <h4>Plugin log</h4>
                    <pre id="log2"></pre>
                </td>
            </tr>
        </tbody>
    </table>

    <!-- Platform -->
    <script>
        // Dummy Platform code
        function loadCase2() {
            const root = document.getElementById('chat2');
            root.innerHTML = 'loading...';

            setTimeout(() => {
                const conversationId = Math.round(Math.random() * 100000);

                root.innerHTML = `
                    <div>
                        <div>Case id: ${conversationId}</div>
                        <textarea data-autocomplete-conversation-id="${conversationId}"></textarea>
                        <button type="submit">Submit</button>
                    </div>
                `;
            }, 500);
        };

        document.getElementById('button2').addEventListener('click', loadCase2);
    </script>

    <!-- Deepdesk plugin -->
    <style>
        @keyframes agentInputInserted {
            from { opacity: 0.99; }
            to { opacity: 1; }
        }

        [data-autocomplete-conversation-id] {
            animation-duration: 0.001s;
            animation-name: agentInputInserted;
        }
    </style>
    <script>
        // Dummy Plugin code
        document.addEventListener("animationstart", event => {
            if (event.animationName == "agentInputInserted") {
                log('log2', `New input detected with conversation ID ${event.target.dataset.autocompleteConversationId}`);
            }
        }, false);

    </script>

    <h2>Reference to input element and a conversation ID (alt)</h2>

    <p>
        An alternative method for the platform to provide the plugin with a reference to the input element and to provide the conversation ID is to utilize Custom DOM events.
    </p>

    <p>
        When a conversation is done rendering in the DOM, we suggest the platform to emit a CustomEvent named 'ConversationLoaded' on the <code>document</code> with the following payload:

        <pre>const event = new CustomEvent('ConversationLoaded', {
    conversationId: "XXXXXXXX", // conversation ID
    inputElementId: "YYYY", // element id of the textarea or contenteditable div
});
document.dispatchEvent(event);</pre>

        <p>
            See <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/Events/Creating_and_triggering_events">Creating and triggering events</a> for details.
        </p>
    </p>

    <p>
        The plugin can listen to the 'ConversationLoaded' event and attach itself to the provided input element and provide suggestings in the context of the provided conversation ID.
    </p>

    <h3>Proof of concept</h3>

    <table>
        <tbody>
            <tr>
                <td width="50%" valign="top">
                    <h4>Agent chat</h4>
                    <button id="button1">Load conversation</button>
                    <br />
                    <div id="chat1"></div>
                </td>
                <td width="50%" valign="top">
                    <h4>Plugin log</h4>
                    <pre id="log1"></pre>
                </td>
            </tr>
        </tbody>
    </table>

    <script>
        function log(target, text) {
            document.getElementById(target).appendChild(document.createTextNode(text + '\n'));
        }
    </script>

    <!-- Platform -->
    <script>
        // Dummy Platform code
        function loadCase1() {
            const root = document.getElementById('chat1');
            root.innerHTML = 'loading...';

            setTimeout(() => {
                const conversationId = Math.round(Math.random() * 100000);

                root.innerHTML = `
                    <div>
                        <div>Case id: ${conversationId}</div>
                        <textarea id="${conversationId}"></textarea>
                        <button type="submit">Submit</button>
                    </div>
                `;

                const event = new CustomEvent('ConversationLoaded', {
                    detail: {
                        conversationId: conversationId,
                        inputElementId: conversationId,
                    }
                });
                document.dispatchEvent(event);
            }, 500);
        };

        document.getElementById('button1').addEventListener('click', loadCase1);
    </script>

    <!-- Deepdesk plugin -->
    <script>
        // Dummy Plugin code
        document.addEventListener('ConversationLoaded', function (event) {
            log('log1', `New input detected with conversation ID ${event.detail.conversationId}`);
        }, false);

    </script>

    <h2>Notify when the typed message is sent</h2>

    <p>
        We propose utilizing DOM events to notify the plugin when the submit process is started and to notify the plugin when the message is succesfully sent.
        These events have to be emitted from the input element itself.

        <pre>/* Agent submits message by Enter or by clicking the submit button: */
textareaElement.dispatchEvent(new Event('ConversationMessageSubmit'));

/* Platform does stuff */

/* When message is sent successfully: */
textareaElement.dispatchEvent(new Event('ConversationMessageSent'));</pre>
    </p>

    <h3>Proof of concept</h3>

    <table>
        <tbody>
            <tr>
                <td width="50%" valign="top">
                    <h4>Agent chat</h4>
                    <br />
                    <div id="chat3">
                        <div>
                            <div>Case id: 123456</div>
                            <textarea id="123456"></textarea>
                            <button type="submit">Submit</button>
                        </div>
                    </div>
                </td>
                <td width="50%" valign="top">
                    <h4>Plugin log</h4>
                    <pre id="log3"></pre>
                </td>
            </tr>
        </tbody>
    </table>

    <script>
        // Dummy Platform code
        const textareaElement = document.getElementById('123456');
        const buttonElement = textareaElement.nextElementSibling;

        buttonElement.addEventListener('click', async () => {
            textareaElement.dispatchEvent(new Event('ConversationMessageSubmit'));

            /* Platform does stuff */
            textareaElement.value = '';
            await new Promise(resolve => setTimeout(resolve, 500));
            /* Platform does stuff */

            textareaElement.dispatchEvent(new Event('ConversationMessageSent'));
        });

        // Dummy Plugin code
        textareaElement.addEventListener('ConversationMessageSubmit', (event) => {
            log('log3', `Message is submitted for conversation 123456`);
        });
        textareaElement.addEventListener('ConversationMessageSent', (event) => {
            log('log3', `Message is successfully sent for conversation 123456`);
        });

    </script>
</body>
</html>